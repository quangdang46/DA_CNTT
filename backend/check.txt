1. Quy trình tổng quan
Quy trình checkout bao gồm các bước sau:

Tạo đơn hàng (Order) : Lưu thông tin đơn hàng vào cơ sở dữ liệu.
Xử lý thanh toán (VNPay) : Chuyển hướng người dùng đến cổng thanh toán VNPay.
Tạo đơn vận chuyển (GHTK) : Gửi thông tin đơn hàng đến GHTK để tạo đơn giao hàng.
Cập nhật trạng thái : Cập nhật trạng thái thanh toán và vận chuyển của đơn hàng.
2. Các API cần sử dụng
A. Tạo đơn hàng (Order)
Mục đích : Lưu thông tin đơn hàng vào cơ sở dữ liệu.
API nội bộ : Sử dụng Laravel để lưu thông tin vào bảng orders và order_items.
Dữ liệu cần gửi :
Thông tin khách hàng (customer_name, customer_email, customer_phone).
Địa chỉ giao hàng (address_id hoặc thông tin địa chỉ chi tiết).
Danh sách sản phẩm (product_id, quantity, price).
Tổng tiền (total_price), phí vận chuyển (shipping_fee), và phương thức thanh toán (payment_method).
B. Xử lý thanh toán với VNPay
Mục đích : Chuyển hướng người dùng đến cổng thanh toán VNPay để thực hiện thanh toán.
API VNPay : Gửi yêu cầu tạo URL thanh toán đến VNPay.
Endpoint : https://sandbox.vnpayment.vn/paymentv2/vpcpay.html (môi trường sandbox) hoặc https://pay.vnpay.vn/vpcpay.html (môi trường production).
Phương thức : POST.
Dữ liệu cần gửi :
vnp_TmnCode: Mã merchant được cung cấp bởi VNPay.
vnp_Amount: Số tiền thanh toán (tính bằng đơn vị nhỏ nhất, ví dụ: 1000 VND = 100000).
vnp_OrderInfo: Mô tả đơn hàng.
vnp_OrderType: Loại đơn hàng (ví dụ: billpayment).
vnp_TxnRef: Mã tham chiếu duy nhất cho đơn hàng (thường là order_id).
vnp_Locale: Ngôn ngữ hiển thị (vn hoặc en).
vnp_ReturnUrl: URL callback khi người dùng hoàn thành thanh toán.
vnp_IpAddr: Địa chỉ IP của người dùng.
vnp_CreateDate: Thời gian tạo đơn hàng (định dạng YYYYMMDDHHmmss).
vnp_SecureHash: Chuỗi hash bảo mật được tạo từ các tham số trên.
Xử lý callback :
Sau khi người dùng hoàn thành thanh toán, VNPay sẽ gọi lại URL vnp_ReturnUrl với các thông tin như vnp_ResponseCode, vnp_TxnRef, và vnp_SecureHash.
Bạn cần kiểm tra tính hợp lệ của vnp_SecureHash và cập nhật trạng thái thanh toán trong bảng payments.
C. Tạo đơn vận chuyển với GHTK
Mục đích : Gửi thông tin đơn hàng đến GHTK để tạo đơn giao hàng.
API GHTK : Gửi yêu cầu tạo đơn hàng đến GHTK.
Endpoint : https://services.giaohangtietkiem.vn/services/shipment/order.
Phương thức : POST.
Dữ liệu cần gửi :
order: Thông tin đơn hàng.
id: Mã đơn hàng (thường là order_id).
pick_name: Tên người gửi.
pick_address: Địa chỉ người gửi.
pick_province: Tỉnh/thành phố người gửi.
pick_district: Quận/huyện người gửi.
pick_tel: Số điện thoại người gửi.
name: Tên người nhận.
address: Địa chỉ người nhận.
province: Tỉnh/thành phố người nhận.
district: Quận/huyện người nhận.
tel: Số điện thoại người nhận.
products: Danh sách sản phẩm.
name: Tên sản phẩm.
weight: Trọng lượng sản phẩm (gam).
quantity: Số lượng sản phẩm.
price: Giá sản phẩm.
value: Tổng giá trị đơn hàng.
transport: Phương thức vận chuyển (ví dụ: road).
Xử lý phản hồi :
GHTK sẽ trả về thông tin đơn hàng, bao gồm mã vận đơn (label) và trạng thái đơn hàng.
Cập nhật thông tin vận đơn (tracking_code, tracking_url) vào bảng orders.
